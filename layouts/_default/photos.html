{{ define "main" }}
<head>
  {{- partial "head.html" . }}
  <link rel="stylesheet" href="/css/photos.css">
</head>

<main>
  <header class="page-header">
    {{ partial "breadcrumbs.html" . }}
    <h1 class="title-with-rss">
      {{ .Title }}
      <a href="/photos/index.xml" title="RSS" aria-label="RSS" class="rss-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" height="23">
          <path d="M4 11a9 9 0 0 1 9 9" />
          <path d="M4 4a16 16 0 0 1 16 16" />
          <circle cx="5" cy="19" r="1" />
        </svg>
      </a>
    </h1>
  </header>
  

  <!-- æ ‡ç­¾æŒ‰é’®åˆ—è¡¨ -->
  <div class="tag-list">
    <button class="tag-filter" data-tag="all">ALL
    </button>

    <!-- åŠ¨æ€ç”Ÿæˆ Tag åˆ—è¡¨ -->
    {{ $tags := slice }}
    {{ $photos := .Site.Data.photos.photos }}
    {{ range $photo := $photos }}
      {{ $tags = $tags | append $photo.tags }}
    {{ end }}
    {{ range $tag := $tags | uniq }}
    <button class="tag-filter" data-tag="{{ $tag }}">{{ $tag }}</button>
    {{ end }}
  </div>

  <!-- ç…§ç‰‡å±•ç¤ºåŒºåŸŸ -->
  <div class="gallery-photos page">
    {{ range $photo := $photos }}
    <div class="gallery-photo" data-tags="
      {{- range $index, $tag := $photo.tags -}}
      {{- if $index }} {{ end }}{{ $tag }}
      {{- end -}}
    ">
      <!-- æ·»åŠ  Fancybox çš„ <a> åŒ…è£¹ -->
      <a href="/photos/{{ $photo.folder }}/{{ $photo.name }}" data-fancybox="gallery" data-caption="{{ $photo.displayName }}">
        <img class="photo-img" loading="lazy" decoding="async" src="/photos/{{ $photo.folder }}/{{ $photo.name }}" alt="{{ $photo.name }}" />
      </a>
      <span class="photo-title">
        {{ if $photo.displayName }}
          {{ $photo.displayName }}
        {{ else }}
          {{ $photo.name }}
        {{ end }}
      </span>
    </div>
    {{ end }}
  </div>
</main>

<!-- æ·»åŠ è„šæœ¬ -->
<script>
 document.addEventListener('DOMContentLoaded', () => {
  const buttons = document.querySelectorAll('.tag-filter');
  const photoContainer = document.querySelector('.gallery-photos');
  const hiddenContainer = document.createElement('div');
  hiddenContainer.style.display = 'none';
  document.body.appendChild(hiddenContainer);

  let layoutTimeout;
  let originalPhotoOrder = []; // **å­˜å‚¨åŽŸå§‹é¡ºåº**

  function getSavedTag() {
    return localStorage.getItem('selectedTag') || 'all';
  }

  function saveTag(tag) {
    localStorage.setItem('selectedTag', tag);
  }

  function resetWaterfall() {
    waterfall('.gallery-photos');
  }

  // **ðŸš€ è®°å½•åˆå§‹é¡ºåº**
  function saveOriginalOrder() {
    originalPhotoOrder = Array.from(document.querySelectorAll('.gallery-photo'));
  }

  // **ðŸ”„ æ¢å¤åŽŸé¡ºåº**
  function restoreOriginalOrder() {
    originalPhotoOrder.forEach(photo => {
      if (!photoContainer.contains(photo)) {
        photoContainer.appendChild(photo);
      }
    });
  }

  function applyFilter(tag) {
    console.log('Applying tag:', tag);

    // åˆ‡æ¢æŒ‰é’®æ ·å¼
    buttons.forEach(btn => btn.classList.remove('active'));
    const activeButton = document.querySelector(`.tag-filter[data-tag="${tag}"]`);
    if (activeButton) {
      activeButton.classList.add('active');
    }

    const allPhotos = Array.from(document.querySelectorAll('.gallery-photo'));

    // **1ï¸âƒ£ éšè—æœªé€‰ä¸­çš„å›¾ç‰‡**
    allPhotos.forEach(photo => {
      const tags = photo.getAttribute('data-tags').trim().split(/\s+/);
      if (tag === 'all' || tags.includes(tag)) {
        photo.style.display = 'block';
        photo.classList.add('visible');
      } else {
        photo.classList.remove('visible');
        photo.style.display = 'none';
        hiddenContainer.appendChild(photo);
      }
    });

    // **2ï¸âƒ£ æ¢å¤åŽŸå§‹é¡ºåº**
    restoreOriginalOrder();

    // **3ï¸âƒ£ é‡æ–°è®¡ç®—ç€‘å¸ƒæµå¸ƒå±€**
    clearTimeout(layoutTimeout);
    layoutTimeout = setTimeout(() => {
      console.log("Resetting waterfall layout...");
      resetWaterfall();
    }, 100);
  }

  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const selectedTag = button.getAttribute('data-tag');
      console.log('Selected tag:', selectedTag);

      saveTag(selectedTag);
      applyFilter(selectedTag);
    });
  });

  // **é¡µé¢åŠ è½½æ—¶ä¿å­˜åŽŸé¡ºåº**
  saveOriginalOrder();

  // **é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„ `tag`**
  const lastSelectedTag = getSavedTag();
  applyFilter(lastSelectedTag);

  // **ç¡®ä¿ `waterfall.js` é‡æ–°è®¡ç®—å¸ƒå±€**
  setTimeout(() => {
    waterfall('.gallery-photos');
  }, 200);
});
  </script>


  <!-- ä½¿ç”¨ Hugo Pipes åŠ è½½ Fancybox çš„ JS æ–‡ä»¶ -->
{{ $fancyboxJS := resources.Get "js/fancybox.umd.min.js" | resources.Minify | resources.Fingerprint }}
<script src="{{ $fancyboxJS.Permalink }}"></script>

<!--ç¯ç®±ç›¸å…³è®¾ç½®-->
<script>
document.addEventListener('DOMContentLoaded', () => {
  Fancybox.bind("[data-fancybox='gallery']", {
    infinite: true,
    Thumbs: {
      autoStart: true,
    },
    caption: function (fancybox, carousel, slide) {
      return slide.$trigger.dataset.caption || "";
    }
  });
});
</script>

<!--ç€‘å¸ƒæµç›¸å…³js-->
 <script src="/js/waterfall.min.js"></script>
 <script src="/js/imgStatus.min.js"></script>
 <script src="/js/view-image.js"></script>
 <script src="/js/lately.min.js"></script>

{{ end }}

